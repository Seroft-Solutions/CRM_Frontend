name: üöÄ Release

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: "Release version (e.g., 1.6.0)"
        required: true
        type: string
      deploy_to:
        description: 'Deploy to which server?'
        required: true
        type: choice
        options:
          - dev
          - prod
          - skip

concurrency:
  group: release
  cancel-in-progress: false

jobs:
  validate_version:
    name: üè∑Ô∏è Validate Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.validate.outputs.version }}
      tag_name: ${{ steps.validate.outputs.tag_name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate version
        id: validate
        run: |
          VERSION="${{ inputs.release_version }}"
          
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "‚ùå Invalid version format: $VERSION"
            echo "Use semantic versioning: X.Y.Z (e.g., 1.6.0)"
            exit 1
          fi
          
          TAG_NAME="v${VERSION}"
          
          if git tag -l | grep -q "^${TAG_NAME}$"; then
            echo "‚ùå Tag already exists: $TAG_NAME"
            exit 1
          fi
          
          echo "‚úÖ Version valid: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

  create_tag:
    name: üè∑Ô∏è Create Tag
    runs-on: ubuntu-latest
    needs: [validate_version]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push tag
        run: |
          TAG_NAME="${{ needs.validate_version.outputs.tag_name }}"
          VERSION="${{ needs.validate_version.outputs.version }}"

          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          git tag -a "$TAG_NAME" -m "Release v$VERSION"
          git push origin "$TAG_NAME"
          
          echo "‚úÖ Created tag: $TAG_NAME"

  build_docker:
    name: üê≥ Build Docker Image
    runs-on: ubuntu-latest
    needs: [validate_version, create_tag]
    env:
      NODE_VERSION: "20"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate_version.outputs.tag_name }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/crm-frontend:${{ needs.validate_version.outputs.tag_name }}
            ${{ secrets.DOCKER_USERNAME }}/crm-frontend:latest
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1
            NODE_ENV=production

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.validate_version.outputs.tag_name }}
          name: Release v${{ needs.validate_version.outputs.version }}
          body: |
            ## üöÄ Release v${{ needs.validate_version.outputs.version }}

            ### üì¶ Docker Image

            ```bash
            docker pull ${{ secrets.DOCKER_USERNAME }}/crm-frontend:${{ needs.validate_version.outputs.tag_name }}
            ```

            **Tags**: `${{ needs.validate_version.outputs.tag_name }}`, `latest`

            ### üìã Changes

            See commit history for detailed changes.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "‚úÖ Release v${{ needs.validate_version.outputs.version }} complete"
          echo "üê≥ Docker: ${{ secrets.DOCKER_USERNAME }}/crm-frontend:${{ needs.validate_version.outputs.tag_name }}"

  deploy:
    name: üöÄ Deploy to Server
    runs-on: ubuntu-latest
    needs: [validate_version, create_tag, build_docker]
    if: inputs.deploy_to != 'skip'
    environment: ${{ inputs.deploy_to == 'prod' && 'production' || 'development' }}
    steps:
      - name: Checkout backend repo for deployment scripts
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/CRM_Backend
          token: ${{ secrets.GITHUB_TOKEN }}
          path: backend

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          SERVER_HOST="${{ inputs.deploy_to == 'prod' && secrets.PROD_SERVER_HOST || secrets.DEV_SERVER_HOST }}"
          ssh-keyscan -p 50489 $SERVER_HOST >> ~/.ssh/known_hosts

      - name: Copy deployment files
        env:
          SERVER_HOST: ${{ inputs.deploy_to == 'prod' && secrets.PROD_SERVER_HOST || secrets.DEV_SERVER_HOST }}
          SERVER_USER: ${{ inputs.deploy_to == 'prod' && secrets.PROD_SERVER_USER || secrets.DEV_SERVER_USER }}
        run: |
          ssh -p 50489 $SERVER_USER@$SERVER_HOST "mkdir -p ~/crm-deployment"
          scp -P 50489 -r backend/src/main/docker $SERVER_USER@$SERVER_HOST:~/crm-deployment/
          ssh -p 50489 $SERVER_USER@$SERVER_HOST "chmod +x ~/crm-deployment/docker/deploy.sh"

      - name: Deploy to ${{ inputs.deploy_to }}
        env:
          TAG: ${{ needs.validate_version.outputs.tag_name }}
          SERVER_HOST: ${{ inputs.deploy_to == 'prod' && secrets.PROD_SERVER_HOST || secrets.DEV_SERVER_HOST }}
          SERVER_USER: ${{ inputs.deploy_to == 'prod' && secrets.PROD_SERVER_USER || secrets.DEV_SERVER_USER }}
          ENVIRONMENT: ${{ inputs.deploy_to }}
        run: |
          echo "üöÄ Deploying release $TAG to $ENVIRONMENT server"
          echo "üìç Server: $SERVER_HOST"
          
          ssh -p 50489 $SERVER_USER@$SERVER_HOST \
            "export BACKEND_TAG='latest' && \
             export FRONTEND_TAG='$TAG' && \
             cd ~/crm-deployment/docker && \
             ./deploy.sh $ENVIRONMENT"

      - name: Deployment summary
        run: |
          echo "‚úÖ Deployed to ${{ inputs.deploy_to }} server"
          echo "üê≥ Backend: latest (independent, not updated by this release)"
          echo "üê≥ Frontend: ${{ needs.validate_version.outputs.tag_name }}"
