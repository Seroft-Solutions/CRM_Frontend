<%#
 Copyright 2013-2025 the original author or authors from the JHipster project.
-%>
"use client";

import React from "react";
import { UseFormReturn } from "react-hook-form";
import {
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";
import { PaginatedRelationshipCombobox } from "../paginated-relationship-combobox";

<%_
// Import statements for all user relationships
const userRelationships = persistableRelationships.filter(rel => {
  const userKeywords = ['user', 'assignedTo', 'createdBy', 'updatedBy', 'channelParty', 'owner'];
  const name = rel.relationshipName.toLowerCase();
  const otherEntity = rel.otherEntityName.toLowerCase();
  return userKeywords.some(kw => name.includes(kw) || otherEntity.includes(kw)) || rel.otherEntity.builtInUser;
});

const uniqueUserEntities = [...new Set(userRelationships.filter(rel => !rel.otherEntity.builtInUser).map(rel => rel.otherEntity.entityFileName))];
_%>

<%_ for (const entityFileName of uniqueUserEntities) { 
  const relEntity = userRelationships.find(rel => rel.otherEntity.entityFileName === entityFileName)?.otherEntity;
_%>
import { 
  useGetAll<%= relEntity.entityClassPlural %>,
  useSearch<%= relEntity.entityClassPlural %>,
  useCount<%= relEntity.entityClassPlural %>
} from "@/core/api/generated/spring/endpoints/<%= entityFileName %>-resource/<%= entityFileName %>-resource.gen";
<%_ } _%>

<%_ if (userRelationships.some(rel => rel.otherEntity.builtInUser)) { _%>
import { 
  useGetAllPublicUsers,
  useSearchPublicUsers
} from "@/core/api/generated/spring/endpoints/public-user-resource/public-user-resource.gen";
<%_ } _%>

<%_
// Helper function to convert camelCase to Title Case
function camelToTitleCase(str) {
  return str
    .replace(/([A-Z])/g, ' $1')
    .replace(/^./, str => str.toUpperCase())
    .trim();
}
_%>

interface <%= entityClass %>StepUsersProps {
  form: UseFormReturn<any>;
  handleEntityCreated: (entityId: number, relationshipName: string) => void;
}

<%_ if (userRelationships.length > 0) { _%>
export function <%= entityClass %>StepUsers({ form, handleEntityCreated }: <%= entityClass %>StepUsersProps) {
  return (
    <div className="space-y-6">
      <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 sm:gap-6">
        <%_ for (const rel of userRelationships) { 
          const relationshipFieldName = rel.relationshipFieldName;
          const relationshipLabel = camelToTitleCase(rel.relationshipName);
          const relationshipRequired = rel.relationshipRequired;
          const otherEntity = rel.otherEntity;
          const displayField = otherEntity.builtInUser ? 'login' : rel.otherEntityField;
        _%>
        <FormField
          control={form.control}
          name="<%= relationshipFieldName %>"
          render={({ field }) => (
            <FormItem>
              <FormLabel className="text-sm font-medium">
                <%= relationshipLabel %><% if (relationshipRequired) { %> *<% } %>
              </FormLabel>
              <FormControl>
                <%_ if (otherEntity.builtInUser) { _%>
                <PaginatedRelationshipCombobox
                  value={field.value}
                  onValueChange={field.onChange}
                  displayField="<%= displayField %>"
                  placeholder="Select <%= relationshipLabel.toLowerCase() %>"
                  multiple={<%= rel.collection %>}
                  useGetAllHook={useGetAllPublicUsers}
                  useSearchHook={useSearchPublicUsers}
                  entityName="PublicUsers"
                  searchField="<%= displayField %>"
                  canCreate={false}
                  createEntityPath=""
                  createPermission=""
                  onEntityCreated={(entityId) => handleEntityCreated(entityId, '<%= relationshipFieldName %>')}
                />
                <%_ } else { _%>
                <PaginatedRelationshipCombobox
                  value={field.value}
                  onValueChange={field.onChange}
                  displayField="<%= displayField %>"
                  placeholder="Select <%= relationshipLabel.toLowerCase() %>"
                  multiple={<%= rel.collection %>}
                  useGetAllHook={useGetAll<%= otherEntity.entityClassPlural %>}
                  useSearchHook={useSearch<%= otherEntity.entityClassPlural %>}
                  useCountHook={useCount<%= otherEntity.entityClassPlural %>}
                  entityName="<%= otherEntity.entityClassPlural %>"
                  searchField="<%= displayField %>"
                  canCreate={true}
                  createEntityPath="/<%= otherEntity.routePath %>/new"
                  createPermission="<%= otherEntity.entityInstance || otherEntity.entityName.toLowerCase() %>:create"
                  onEntityCreated={(entityId) => handleEntityCreated(entityId, '<%= relationshipFieldName %>')}
                />
                <%_ } _%>
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />
        <%_ } _%>      </div>
    </div>
  );
}
<%_ } else { _%>
export function <%= entityClass %>StepUsers() { return null; }
<%_ } _%>
