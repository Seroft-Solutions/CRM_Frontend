<%#
 Copyright 2013-2025 the original author or authors from the JHipster project.
-%>
"use client";

import React from "react";
import { UseFormReturn } from "react-hook-form";
import {
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";
import { PaginatedRelationshipCombobox } from "../paginated-relationship-combobox";

<%_
// Import statements for all geographic relationships
const geographicRelationships = persistableRelationships.filter(rel => {
  const geographicKeywords = ['state', 'district', 'city', 'area', 'country', 'region', 'location'];
  const name = rel.relationshipName.toLowerCase();
  const otherEntity = rel.otherEntityName.toLowerCase();
  return geographicKeywords.some(kw => name.includes(kw) || otherEntity.includes(kw));
});

const uniqueGeoEntities = [...new Set(geographicRelationships.map(rel => rel.otherEntity.entityFileName))];
_%>

<%_ for (const entityFileName of uniqueGeoEntities) { 
  const relEntity = geographicRelationships.find(rel => rel.otherEntity.entityFileName === entityFileName)?.otherEntity;
_%>
import { 
  useGetAll<%= relEntity.entityClassPlural %>,
  useSearch<%= relEntity.entityClassPlural %>,
  useCount<%= relEntity.entityClassPlural %>
} from "@/core/api/generated/spring/endpoints/<%= entityFileName %>-resource/<%= entityFileName %>-resource.gen";
<%_ } _%>

<%_
// Helper function to convert camelCase to Title Case
function camelToTitleCase(str) {
  return str
    .replace(/([A-Z])/g, ' $1')
    .replace(/^./, str => str.toUpperCase())
    .trim();
}

// Sort geographic relationships by hierarchy
const geoOrder = ['state', 'district', 'city', 'area'];
const sortedGeoRels = geographicRelationships.sort((a, b) => {
  const aIndex = geoOrder.findIndex(geo => a.relationshipName.toLowerCase().includes(geo));
  const bIndex = geoOrder.findIndex(geo => b.relationshipName.toLowerCase().includes(geo));
  return (aIndex === -1 ? 999 : aIndex) - (bIndex === -1 ? 999 : bIndex);
});
_%>

interface <%= entityClass %>StepGeographicProps {
  form: UseFormReturn<any>;
  handleEntityCreated: (entityId: number, relationshipName: string) => void;
}

<%_ if (geographicRelationships.length > 0) { _%>
export function <%= entityClass %>StepGeographic({ form, handleEntityCreated }: <%= entityClass %>StepGeographicProps) {
  return (
    <div className="space-y-6">
      <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 sm:gap-6">
        <%_ 
        for (let i = 0; i < sortedGeoRels.length; i++) {
          const rel = sortedGeoRels[i];
          const relationshipFieldName = rel.relationshipFieldName;
          const relationshipLabel = camelToTitleCase(rel.relationshipName);
          const relationshipRequired = rel.relationshipRequired;
          const otherEntity = rel.otherEntity;
          const displayField = rel.otherEntityField;
          
          const parentRel = i > 0 ? sortedGeoRels[i - 1] : null;
          const parentFieldName = parentRel ? parentRel.relationshipFieldName : null;
        _%>
        <FormField
          control={form.control}
          name="<%= relationshipFieldName %>"
          render={({ field }) => (
            <FormItem>
              <FormLabel className="text-sm font-medium">
                <%= relationshipLabel %><% if (relationshipRequired) { %> *<% } %>
              </FormLabel>
              <FormControl>
                <PaginatedRelationshipCombobox
                  value={field.value}
                  onValueChange={(value) => {
                    field.onChange(value);
                    // Clear dependent geographic selections
                    <%_ for (let j = i + 1; j < sortedGeoRels.length; j++) { 
                      const dependentRel = sortedGeoRels[j];
                    _%>
                    form.setValue('<%= dependentRel.relationshipFieldName %>', undefined);
                    <%_ } _%>
                  }}
                  displayField="<%= displayField %>"
                  placeholder="Select <%= relationshipLabel.toLowerCase() %>"
                  multiple={<%= rel.collection %>}
                  useGetAllHook={useGetAll<%= otherEntity.entityClassPlural %>}
                  useSearchHook={useSearch<%= otherEntity.entityClassPlural %>}
                  useCountHook={useCount<%= otherEntity.entityClassPlural %>}
                  entityName="<%= otherEntity.entityClassPlural %>"
                  searchField="<%= displayField %>"
                  canCreate={true}
                  createEntityPath="/<%= otherEntity.routePath %>/new"
                  createPermission="<%= otherEntity.entityInstance || otherEntity.entityName.toLowerCase() %>:create"
                  onEntityCreated={(entityId) => handleEntityCreated(entityId, '<%= relationshipFieldName %>')}
                  <%_ if (parentFieldName) { _%>
                  parentFilter={form.watch('<%= parentFieldName %>')}
                  parentField="<%= parentFieldName %>"
                  disabled={!form.watch('<%= parentFieldName %>')}
                  <%_ } _%>
                />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />
        <%_ } _%>
      </div>
    </div>
  );
}
<%_ } else { _%>
export function <%= entityClass %>StepGeographic() { return null; }
<%_ } _%>
