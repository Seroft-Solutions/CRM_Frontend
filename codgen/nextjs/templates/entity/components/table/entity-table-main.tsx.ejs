<%#
 Copyright 2013-2025 the original author or authors from the JHipster project.
-%>
"use client";

import { useState } from "react";
import Link from "next/link";
import { useRouter } from "next/navigation";
import {
  ChevronDown,
  ChevronUp,
  ChevronsUpDown,
  Eye,
  Pencil,
  Trash2,
  X
} from "lucide-react";
import { toast } from "sonner";
import { Button } from "@/components/ui/button";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import { 
  Pagination, 
  PaginationContent, 
  PaginationItem, 
  PaginationLink, 
  PaginationNext, 
  PaginationPrevious 
} from "@/components/ui/pagination";
import { Badge } from "@/components/ui/badge";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import { format } from "date-fns";

import {
  useGetAll<%= entityClassPlural %>,
  useDelete<%= entityClass %>,
  useCount<%= entityClassPlural %>,
  <% if (searchEngineAny) { %>useSearch<%= entityClassPlural %>,<% } %>
} from "@/core/api/generated/endpoints/<%= entityFileName %>-resource/<%= entityFileName %>-resource.gen";

import { <%= entityClass %>SearchAndFilters } from "./<%= entityFileName %>-search-filters";
import { <%= entityClass %>TableHeader } from "./<%= entityFileName %>-table-header";
import { <%= entityClass %>TableRow } from "./<%= entityFileName %>-table-row";

<%
// Define table relationships once at the top to avoid redeclaration
const displayableRelationships = relationships.filter(rel => 
  rel.relationshipType !== 'one-to-many' && 
  !rel.collection && 
  rel.otherEntityField
);
%>

// Define sort ordering constants
const ASC = "asc";
const DESC = "desc";

interface FilterState {
  [key: string]: string | string[] | Date | undefined;
}

interface DateRange {
  from: Date | undefined;
  to: Date | undefined;
}

export function <%= entityClass %>Table() {
  const router = useRouter();
  const [page, setPage] = useState(1);
  const [sort, setSort] = useState("<%= primaryKey.name %>");
  const [order, setOrder] = useState(ASC);
  const [searchTerm, setSearchTerm] = useState("");
  const [deleteId, setDeleteId] = useState<number | null>(null);
  const [showDeleteDialog, setShowDeleteDialog] = useState(false);
  const [filters, setFilters] = useState<FilterState>({});
  const [dateRange, setDateRange] = useState<DateRange>({ from: undefined, to: undefined });

  // Calculate API pagination parameters (0-indexed)
  const apiPage = page - 1;
  const pageSize = 10;

  // Build filter parameters for API
  const buildFilterParams = () => {
    const params: Record<string, any> = {};
    
    // Add regular filters
    Object.entries(filters).forEach(([key, value]) => {
      if (value !== undefined && value !== "" && value !== null) {
        if (Array.isArray(value) && value.length > 0) {
          params[key] = value;
        } else if (value instanceof Date) {
          params[key] = value.toISOString().split('T')[0];
        } else if (typeof value === 'string' && value.trim() !== '') {
          params[key] = value;
        }
      }
    });

    // Add date range filters
    if (dateRange.from && dateRange.to) {
      // Add your date range logic here based on your API
    }

    return params;
  };

  const filterParams = buildFilterParams();

  // Fetch data with React Query
  <% if (searchEngineAny) { %>
  const { data, isLoading, refetch } = searchTerm 
    ? useSearch<%= entityClassPlural %>(
        {
          query: searchTerm,
          page: apiPage,
          size: pageSize,
          sort: `${sort},${order}`,
          ...filterParams,
        },
        {
          query: {
            enabled: true,
          },
        }
      )
    : 
  <% } %>
  const { data, isLoading, refetch } = useGetAll<%= entityClassPlural %>(
    {
      page: apiPage,
      size: pageSize,
      sort: `${sort},${order}`,
      ...filterParams,
    },
    {
      query: {
        enabled: true,
      },
    }
  );

  // Get total count for pagination
  const { data: countData } = useCount<%= entityClassPlural %>(
    filterParams,
    {
      query: {
        enabled: true,
      },
    }
  );

  // Delete mutation
  const { mutate: deleteEntity, isPending: isDeleting } = useDelete<%= entityClass %>({
    mutation: {
      onSuccess: () => {
        toast.success("<%= entityClass %> deleted successfully");
        refetch();
      },
      onError: (error) => {
        toast.error(`Failed to delete <%= entityClass %>: ${error}`);
      },
    },
  });

  // Handle sort column click
  const handleSort = (column: string) => {
    if (sort === column) {
      setOrder(order === ASC ? DESC : ASC);
    } else {
      setSort(column);
      setOrder(ASC);
    }
  };

  // Get sort direction icon
  const getSortIcon = (column: string) => {
    if (sort !== column) {
      return <ChevronsUpDown className="h-4 w-4" />;
    }
    return order === ASC ? <ChevronUp className="h-4 w-4" /> : <ChevronDown className="h-4 w-4" />;
  };

  // Handle delete
  const handleDelete = (id: number) => {
    setDeleteId(id);
    setShowDeleteDialog(true);
  };

  const confirmDelete = () => {
    if (deleteId) {
      deleteEntity({ id: deleteId });
    }
    setShowDeleteDialog(false);
  };

  // Handle filter change
  const handleFilterChange = (column: string, value: any) => {
    setFilters(prev => ({
      ...prev,
      [column]: value
    }));
    setPage(1);
  };

  // Clear all filters
  const clearAllFilters = () => {
    setFilters({});
    setSearchTerm("");
    setDateRange({ from: undefined, to: undefined });
    setPage(1);
  };

  <% if (searchEngineAny) { %>
  // Handle search
  const handleSearch = (e: React.ChangeEvent<HTMLInputElement>) => {
    setSearchTerm(e.target.value);
    setPage(1);
  };
  <% } %>

  // Calculate total pages
  const totalItems = countData || 0;
  const totalPages = Math.ceil(totalItems / pageSize);

  // Check if any filters are active
  const hasActiveFilters = Object.keys(filters).length > 0 || searchTerm || dateRange.from || dateRange.to;

  return (
    <div className="space-y-4">
      {/* Search and Filter Component */}
      <<%= entityClass %>SearchAndFilters 
        searchTerm={searchTerm}
        onSearchChange={<% if (searchEngineAny) { %>handleSearch<% } else { %>(e) => setSearchTerm(e.target.value)<% } %>}
        filters={filters}
        onFilterChange={handleFilterChange}
        dateRange={dateRange}
        onDateRangeChange={setDateRange}
        onClearAll={clearAllFilters}
        hasActiveFilters={hasActiveFilters}
      />

      {/* Data Table */}
      <div className="overflow-x-auto rounded-md border">
        <Table className="min-w-full">
          <<%= entityClass %>TableHeader 
            onSort={handleSort}
            getSortIcon={getSortIcon}
          />
          <TableBody>
            {isLoading ? (
              <TableRow>
                <TableCell
                  colSpan={<%= fields.length + displayableRelationships.length + 1 %>}
                  className="h-24 text-center"
                >
                  Loading...
                </TableCell>
              </TableRow>
            ) : data?.length ? (
              data.map((<%= entityInstance %>) => (
                <<%= entityClass %>TableRow
                  key={<%= entityInstance %>.<%= primaryKey.name %>}
                  <%= entityInstance %>={<%= entityInstance %>}
                  onDelete={handleDelete}
                  isDeleting={isDeleting}
                />
              ))
            ) : (
              <TableRow>
                <TableCell
                  colSpan={<%= fields.length + displayableRelationships.length + 1 %>}
                  className="h-24 text-center"
                >
                  No <%= entityClassPluralHumanized.toLowerCase() %> found
                  {hasActiveFilters && (
                    <div className="text-sm text-muted-foreground mt-1">
                      Try adjusting your filters
                    </div>
                  )}
                </TableCell>
              </TableRow>
            )}
          </TableBody>
        </Table>
      </div>

      {/* Pagination */}
      {totalPages > 1 && (
        <Pagination>
          <PaginationContent>
            <PaginationItem>
              <PaginationPrevious
                href="#"
                onClick={(e) => {
                  e.preventDefault();
                  if (page > 1) setPage(page - 1);
                }}
                className={page <= 1 ? "pointer-events-none opacity-50" : ""}
              />
            </PaginationItem>
            {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
              const pageNumbers = [];
              const startPage = Math.max(1, page - 2);
              const endPage = Math.min(totalPages, startPage + 4);
              
              for (let j = startPage; j <= endPage; j++) {
                pageNumbers.push(j);
              }
              
              return pageNumbers[i];
            }).filter(Boolean).map((p) => (
              <PaginationItem key={p}>
                <PaginationLink
                  href="#"
                  onClick={(e) => {
                    e.preventDefault();
                    setPage(p);
                  }}
                  isActive={page === p}
                >
                  {p}
                </PaginationLink>
              </PaginationItem>
            ))}
            <PaginationItem>
              <PaginationNext
                href="#"
                onClick={(e) => {
                  e.preventDefault();
                  if (page < totalPages) setPage(page + 1);
                }}
                className={page >= totalPages ? "pointer-events-none opacity-50" : ""}
              />
            </PaginationItem>
          </PaginationContent>
        </Pagination>
      )}

      {/* Delete Dialog */}
      <AlertDialog open={showDeleteDialog} onOpenChange={setShowDeleteDialog}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>Are you sure?</AlertDialogTitle>
            <AlertDialogDescription>
              This action cannot be undone. This will permanently delete the
              <%= entityClass.toLowerCase() %> and remove its data from the server.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel>Cancel</AlertDialogCancel>
            <AlertDialogAction 
              onClick={confirmDelete}
              className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
            >
              Delete
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  );
}
